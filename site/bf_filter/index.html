<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../img/favicon.ico" rel="shortcut icon"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
<title>
    Filter - LunaX - Betaflight Docs
   </title>
<link href="../css/bootstrap-3.3.7.min.css" rel="stylesheet"/>
<link href="../css/font-awesome-4.7.0.css" rel="stylesheet"/>
<link href="../css/base.css" rel="stylesheet"/>
<link href="../css/highlight.css" rel="stylesheet"/>
<link href="../css/pdf.css" rel="stylesheet"/>
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
<script src="../js/jquery-3.2.1.min.js">
</script>
<script src="../js/bootstrap-3.3.7.min.js">
</script>
<script src="../js/highlight.pack.js">
</script>
<base target="_top"/>
<script>
    var base_url = '..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "FILTER Ein mal Eins", url: "#_top", children: [
              {title: "Inhaltsverzeichnis", url: "#inhaltsverzeichnis" },
              {title: "Historie", url: "#historie" },
          ]},
          {title: "Allgemeines", url: "#allgemeines", children: [
              {title: "Typische Frequenzen", url: "#typische-frequenzen" },
              {title: "Noise / Vibrationen", url: "#noise-vibrationen" },
              {title: "Oszillation", url: "#oszillation" },
              {title: "Harmonics", url: "#harmonics" },
          ]},
          {title: "Gyro-Data-Filtering", url: "#gyro-data-filtering", children: [
          ]},
          {title: "Grundlage Filter-Arten", url: "#grundlage-filter-arten", children: [
              {title: "Lowpass-Filter", url: "#lowpass-filter" },
              {title: "Notch-Filter", url: "#notch-filter" },
              {title: "Static-Filter", url: "#static-filter" },
              {title: "Dynamic-Filter", url: "#dynamic-filter" },
          ]},
          {title: "Betaflight-Filter", url: "#betaflight-filter", children: [
              {title: "RPM-Filter", url: "#rpm-filter" },
              {title: "BF - Dynamic-Lowpassfilter", url: "#bf-dynamic-lowpassfilter" },
              {title: "BF - Static Notchfilter", url: "#bf-static-notchfilter" },
              {title: "BF - Dynamic-Notchfilter", url: "#bf-dynamic-notchfilter" },
              {title: "BF - Static-Lowpassfilter", url: "#bf-static-lowpassfilter" },
              {title: "BF - Gyro-RPM-Filter", url: "#bf-gyro-rpm-filter" },
              {title: "BF - Gyro-LowPass Filter", url: "#bf-gyro-lowpass-filter" },
              {title: "BF - DTerm LowPass Filter", url: "#bf-dterm-lowpass-filter" },
          ]},
          {title: "Appendix", url: "#appendix", children: [
              {title: "Bilder in gr\u00f6\u00dferem Format", url: "#bilder-in-groerem-format" },
          ]},
        ];
   </script>
<script src="../js/base.js">
</script>
<script src="../js/mermaid.min.js">
</script>
</head>
<body>
<script>
   if (is_top_frame) { $('body').addClass('wm-top-page'); }
  </script>
<div class="container-fluid wm-page-content">
<a name="_top">
</a>
<script>
    if(window.location.search.match(pdf/))
{
    setTimeout(() =>
    {
        mermaid.init(null, document.getElementsByClassName('mermaid'));
    }, 1000);
}
   </script>
<h2 id="filter-ein-mal-eins">
<em>
     FILTER Ein mal Eins
    </em>
<a class="headerlink" href="#filter-ein-mal-eins" title="Permanent link">
     #
    </a>
</h2>
<h3 id="inhaltsverzeichnis">
    Inhaltsverzeichnis
    <a class="headerlink" href="#inhaltsverzeichnis" title="Permanent link">
     #
    </a>
</h3>
<div class="toc">
<ul>
<li>
<a href="#filter-ein-mal-eins">
       FILTER Ein mal Eins
      </a>
<ul>
<li>
<a href="#inhaltsverzeichnis">
         Inhaltsverzeichnis
        </a>
</li>
<li>
<a href="#historie">
         Historie
        </a>
</li>
</ul>
</li>
<li>
<a href="#allgemeines">
       Allgemeines
      </a>
<ul>
<li>
<a href="#typische-frequenzen">
         Typische Frequenzen
        </a>
</li>
<li>
<a href="#noise-vibrationen">
         Noise / Vibrationen
        </a>
</li>
<li>
<a href="#oszillation">
         Oszillation
        </a>
</li>
<li>
<a href="#harmonics">
         Harmonics
        </a>
</li>
</ul>
</li>
<li>
<a href="#gyro-data-filtering">
       Gyro-Data-Filtering
      </a>
</li>
<li>
<a href="#grundlage-filter-arten">
       Grundlage Filter-Arten
      </a>
<ul>
<li>
<a href="#lowpass-filter">
         Lowpass-Filter
        </a>
</li>
<li>
<a href="#notch-filter">
         Notch-Filter
        </a>
</li>
<li>
<a href="#static-filter">
         Static-Filter
        </a>
</li>
<li>
<a href="#dynamic-filter">
         Dynamic-Filter
        </a>
</li>
</ul>
</li>
<li>
<a href="#betaflight-filter">
       Betaflight-Filter
      </a>
<ul>
<li>
<a href="#rpm-filter">
         RPM-Filter
        </a>
</li>
<li>
<a href="#bf-dynamic-lowpassfilter">
         BF - Dynamic-Lowpassfilter
        </a>
</li>
<li>
<a href="#bf-static-notchfilter">
         BF - Static Notchfilter
        </a>
</li>
<li>
<a href="#bf-dynamic-notchfilter">
         BF - Dynamic-Notchfilter
        </a>
</li>
<li>
<a href="#bf-static-lowpassfilter">
         BF - Static-Lowpassfilter
        </a>
<ul>
<li>
<a href="#pt1">
           PT1
          </a>
</li>
<li>
<a href="#biquad">
           BIQUAD
          </a>
</li>
</ul>
</li>
<li>
<a href="#bf-gyro-rpm-filter">
         BF - Gyro-RPM-Filter
        </a>
</li>
<li>
<a href="#bf-gyro-lowpass-filter">
         BF - Gyro-LowPass Filter
        </a>
</li>
<li>
<a href="#bf-dterm-lowpass-filter">
         BF - DTerm LowPass Filter
        </a>
</li>
</ul>
</li>
<li>
<a href="#appendix">
       Appendix
      </a>
<ul>
<li>
<a href="#bilder-in-groerem-format">
         Bilder in größerem Format
        </a>
</li>
</ul>
</li>
</ul>
</div>
<p>
    {{TOC}}
   </p>
<h3 id="historie">
    Historie
    <a class="headerlink" href="#historie" title="Permanent link">
     #
    </a>
</h3>
<table>
<thead>
<tr>
<th align="center">
       Version
      </th>
<th>
       Datum
      </th>
<th>
       Inhalt
      </th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
       0.1
      </td>
<td>
       August 2020
      </td>
<td>
       initial
      </td>
</tr>
</tbody>
</table>
<hr/>
<h2 id="allgemeines">
    Allgemeines
    <a class="headerlink" href="#allgemeines" title="Permanent link">
     #
    </a>
</h2>
<h3 id="typische-frequenzen">
    Typische Frequenzen
    <a class="headerlink" href="#typische-frequenzen" title="Permanent link">
     #
    </a>
</h3>
<p>
    Vibrationen die am Copter auftreten lassen sich in verschiede Frequenzbereiche unterteilen
   </p>
<ul>
<li>
     0 ~ 20Hz: normaler Frequenzbereich während des Fliegens (keine Filterung der Signale)
    </li>
<li>
     20 ~ 80Hz: Vibrationen niedriger Frequenz (häufig Propwash)
    </li>
<li>
     80 ~ 1000Hz: hochfrequente Vibrationen (Noise) verursacht durch
     <ul>
<li>
       Motorvibrationen &amp; Prop-Resonanzen. Hier sieht man auch das typische Bild des 
Motor-Vibrations-Bandes
       <a href="#harmonics">
        Harmonics
       </a>
</li>
<li>
       Frame-Resonanzen
      </li>
<li>
       ...
      </li>
</ul>
</li>
</ul>
<hr/>
<h3 id="noise-vibrationen">
<em>
     Noise / Vibrationen
    </em>
<a class="headerlink" href="#noise-vibrationen" title="Permanent link">
     #
    </a>
</h3>
<p>
    Ist eine Bezeichnung für Rauschen bzw. Gyro-Signale die nicht zu den gewünschten/benötigten Signalen sind, die durch den FC verarbeitet werden müssen. Dies entspricht demnach Messwerten, die irregulär sind und die Performance des Copters negativ beeinflussen.
   </p>
<p>
    Noise (Rauschen) kann ausgelöst werden durch:
   </p>
<ul>
<li>
     äußere Einflüsse (z.B. Wind, Kontakte mit Ästen, ...)
    </li>
<li>
     Vibrationen am Chassis (z.B. lose schrauben, dünne schwingende Arme, ...)
    </li>
<li>
     Vibrationen durch Motoren(z.B. Lagerschäden, Unwucht, ...)
    </li>
<li>
     Vibrationen durch Props (z.B. Unwucht, Prop-Wash, ...)
    </li>
<li>
     Kombinationen aus allem •.
    </li>
</ul>
<p>
    Noise wird durch den Gyro und anschließend durch den PID- Controller verarbeitet und kann zu fehlerhaften Verhalten führen.
   </p>
<p>
    Eingesetzte Filter
    <a href="#lowpass-filter">
     LPF
    </a>
<sup id="fnref:LPF">
<a class="footnote-ref" href="#fn:LPF">
      5
     </a>
</sup>
    ,
    <a href="#notch-filter">
     NOTCH
    </a>
<sup id="fnref:NF">
<a class="footnote-ref" href="#fn:NF">
      4
     </a>
</sup>
    ,
    <a href="#rpm-filter">
     RPM
    </a>
<sup id="fnref:RPM">
<a class="footnote-ref" href="#fn:RPM">
      1
     </a>
</sup>
    ,
    <a href="#bf-dterm-lowpass-filter">
     DTerm
    </a>
<sup id="fnref:DTF">
<a class="footnote-ref" href="#fn:DTF">
      6
     </a>
</sup>
    versuchen dieses Rauschen zu eliminieren.
   </p>
<p>
    Eine Deiner Hauptaufgabe beim Tunen Deines Copters ist, dass du diese Vibrationen in den Griff bekommst ohne deutliche Delay zu bekommen.
   </p>
<p>
<img alt="Noise1" src="../images/noise1.png" title="PIDToolbox - Vibrationen (Motor-Noise-Band)"/>
</p>
<div class="admonition note">
<p class="admonition-title">
     Hinweis
    </p>
<p>
     Der DTerm-Anteil des PID-Controllers verstärkt Vibrationen deutlich. Daher ist eine Abstimmung der Filter mit dem DTerm
     <sup id="fnref2:DTF">
<a class="footnote-ref" href="#fn:DTF">
       6
      </a>
</sup>
     gut abzustimmen.
    </p>
</div>
<p>
    Um Vibrationen zu analysieren musst du eine Blackbox-Analyse durchführen oder Tools wie
    <code>
     Blackbox-Explorer
    </code>
    ,
    <code>
     PIDToolbox
    </code>
    oder
    <code>
     Plasmatree
    </code>
    verwenden.
   </p>
<p>
    Um einen ersten Eindruck von Vibrationen zu erhalten empfehle ich eine
    <a href="https://github.com/mrRobot62/PIDtoolbox/wiki/SpectralAnalyzer">
     Spektral-Analyse
    </a>
    .  Hier sieht man sehr deutlich in welchem Frequenzband Vibrationen an Deinem Copter auftreten.
   </p>
<p>
    Filter helfen, diese Vibrationen möglichst aus den Signalen für den Flight-Controller herauszufiltern um anschließend den Motoren möglichst saubere Signale zu übermitteln.
   </p>
<div class="admonition note">
<p class="admonition-title">
     Tip
    </p>
<p>
     Bevor du damit startetest die PID-Werte anzupassen, stelle Deine Filter optimal auf Deinen Copter ein. Erst dann fängst du mit den PID-Werten an. Versuche durch Deine Filter ein maximales Gyro &amp; DTerm Delay von &lt;5ms zu erreichen. Du kannst das sehr einfach mit
     <code>
      PIDToolbox
     </code>
     erkennen.
    </p>
</div>
<hr/>
<h3 id="oszillation">
<em>
     Oszillation
    </em>
<a class="headerlink" href="#oszillation" title="Permanent link">
     #
    </a>
</h3>
<p>
    Eine Oszillation ist eine Schwingung. In Bezug auf den PID-Controller ist es ein Über- und Unterschwingen zur Ideallinie.
   </p>
<p>
<img alt="Oszillation0" src="../images/oszillation0.png" title="Oszillation - Schaubild"/>
</p>
<ul>
<li>
<strong>
      SetPoint
     </strong>
     = SOLL-Wert = gestrichelte Linie (das ist das RC-Kommando z.B. 700deg/sec)
    </li>
<li>
<p>
<strong>
       Orangene-Linie
      </strong>
      ein Versuch sich möglichst schnell an den Soll-Wert heranzutasten. Man überschießt den Soll-Wert korrigiert und fällt unter den Soll-Wert, korrigiert dann wieder überschießt man usw. bis man irgendwann den Sollwert Erreicht.
     </p>
</li>
<li>
<p>
<strong>
       Ideal
      </strong>
      ist es, wenn man die
      <strong>
       grüne Linie
      </strong>
      ) möglichst schnell ohne bzw. geringer Oszillation den Sollwert erreicht
     </p>
</li>
<li>
<p>
<strong>
       Blauer Bereich
      </strong>
      Schafft es der PID-Controller überhaupt nicht den Soll-Wert zu erreichen dann bewegt man sich in diesem Bereich. Schnelles Oszillieren wird als Vibration empfunden.
     </p>
</li>
</ul>
<p>
    Nachfolgend ein Bild aus dem Blackbox-Explorer bei dem man sehr deutlich diese Oszillation sehen kann
   </p>
<p>
<img alt="Oszillation1" src="../images/oszillation1.png" title="Blackbox-Explorer - Oszillation"/>
</p>
<p>
    Im nachfolgenden Bild sieht man im oberen Graphen die Oszillation auf der Roll-Achse und welche Auswirkungen diese auf die Motoren haben.
Dies läßt sich nur bedingt durch Filter bereinigen, sondern über die PID-Einstellungen.
    <img alt="Oszillation2" src="../images/oszillation2.png" title="Blackbox-Explorer - Oszillation unruhige Motoren"/>
</p>
<p>
    Nachfolgende Bildfolge zeigt die obigen beschriebenen Vibrationen der Motoren bei einem Punch. Analyse über PIDToolbox[^PDT]
   </p>
<table>
<thead>
<tr>
<th>
<div style="width:400px">
        Roll
       </div>
</th>
<th>
       Info
      </th>
</tr>
</thead>
<tbody>
<tr>
<td>
<img alt="" src="../images/oszillation_lres_0b.png"/>
</td>
<td>
       Diese Ansicht zeigt den Verlauf kurz vor einer Snap-Roll. Der obere Graph zeigt die Roll-Achse. Der untere Graph zeigt zeitgleich Throttle. Man sieht auch, das ich meine Roll-Rates auf 700deg/sec stehen
      </td>
</tr>
<tr>
<td>
<img alt="" src="../images/oszillation_lres_1.png"/>
</td>
<td>
       Dieser Graph zeigt Details der Roll-Daten. Die schwarze Linie entspricht den Gyro-Daten, die rote Linie ist der Setpoint, die grün Line zeigt den PTerm und die blaue Linie den DTerm. Hier sieht man das PTerm und DTerm gegenläufig arbeiten. Weiterhin erkennt man am die Oszillation des Gyros beim Erreichen des Setpoints.
      </td>
</tr>
<tr>
<td>
<img alt="" src="../images/oszillation_lres_1b.png"/>
</td>
<td>
       Nun eine noch genauere Darstellung der Roll-Daten beim Erreichen des Setpoints. Deutliche Oszillation des Gypros was darauf hindeutet, dass der PID-Controller noch nicht optimiert ist.
      </td>
</tr>
<tr>
<td>
<img alt="" src="../images/oszillation_lres_2a.png"/>
</td>
<td>
       Hier nun die Motordaten kurz bei Full-Throttle am Beispiel von Motor 1. Schwarze Linie ist Throttle, rote Linie ist Motor1. Die Vibrationen die man vor der Snap-Roll im Bild 2 deutlich sieht, sieht man auch hier in den Motordaten. Diese Motor-Signale können zu den Vibrationen führen und auch zur Motor-Überhizung. Wichtig ist, das man die Motor-Temperatur nach einem Flug überprüft - erst recht, wenn man versucht seinen Copter zu tunen. Zwischen Throttle reduzieren und Beginn der Snap-Roll liegen ca. 500ms
      </td>
</tr>
</tbody>
</table>
<hr/>
<h3 id="harmonics">
<em>
     Harmonics
    </em>
<a class="headerlink" href="#harmonics" title="Permanent link">
     #
    </a>
</h3>
<p>
    Harmonics oder Harmonische sind wiederkehrende Amplituden (Vibrationen) in den gleichen Frequenzabständen.
   </p>
<p>
    Das nachfolgende Bild zeigt deutlich drei sich im gleichen Abstand wiederholende Frequenz-Peaks von Vibrationen (Motor Vibrationen)
   </p>
<p>
    Beginnend mit dem Motor-Noise-Peak bei 158hz, dann die erste Harmonische Amplitude bei 316hz (2x158hz) und die dritte Amplitude bei 474hz (3x158).
   </p>
<p>
<img alt="bbe_harmonics1.png" src="../images/bbe_harmonics1.png" title="Harmonics"/>
</p>
<h2 id="gyro-data-filtering">
    Gyro-Data-Filtering
    <a class="headerlink" href="#gyro-data-filtering" title="Permanent link">
     #
    </a>
</h2>
<p>
    Signal &amp; Prozessfluß zur Filterung
   </p>
<div class="mermaid">
    graph LR
    classDef dbg fill:#ddd
    classDef LP fill:#f96

    LS((Loop-Start&lt;br&gt;d/t)):::LP --&gt; GY(Gyro)
    GY -.-&gt; DBG1[[DebugMode&lt;br&gt;Gyro_Raw&lt;br&gt;Notch&lt;br&gt;FFT]]:::dbg
    GY --&gt; DNF
    DBG1 -.-&gt; DNF(Dynamic Notch Filter)
    DNF -.-&gt; DBGFFT[[DebugMode&lt;br&gt;FFT]]:::dbg
    DNF --&gt; SNF(Static Notch Filter)
    DBGFFT -.-&gt; SNF
   </div>
<div class="mermaid">
    graph LR
    classDef dbg fill:#ddd

    SNF(Static Notch Filter) --&gt; GLPF
    SNF -.-&gt; DBGGY[[DebugMode&lt;br&gt;Gyro]]:::dbg
    DBGGY -.-&gt; GLPF(Gyro LPF&lt;br&gt;LowPass Filter)
    GLPF --&gt; PID(PID Loop)
   </div>
<div class="mermaid">
    graph LR
    classDef dbg fill:#ddd

    PID(PID Loop) -.-&gt; DBGDF[[DebugMode&lt;br&gt;DFilter]]:::dbg
    PID --&gt; DTLPF(DTerm&lt;br&gt;LPF)
    DBGDF -.-&gt; DTLPF
    DTLPF --&gt; DTNF(DTerm&lt;br&gt;Notch Filter)
   </div>
<div class="mermaid">
    graph LR
    classDef dbg fill:#ddd
    classDef LP fill:#f96

    DTNF(DTerm&lt;br&gt;Notch Filter) --&gt; M(Motoren)
    M --&gt; LE((Loop-End)):::LP
   </div>
<h2 id="grundlage-filter-arten">
    Grundlage Filter-Arten
    <a class="headerlink" href="#grundlage-filter-arten" title="Permanent link">
     #
    </a>
</h2>
<h3 id="lowpass-filter">
<em>
     Lowpass-Filter
    </em>
<a class="headerlink" href="#lowpass-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Niedrige Frequenzen werden durch den Filter durchgelassen, hohe Frequenzen werden gedämpft.
   </p>
<p>
    Hohe Frequenzen sind in der Regel im System nur Rauschen bzw. Vibrationen und werden für die Flugdaten nicht benötigt, daher versucht man sie herauszufiltern.
   </p>
<p>
    Mit dem LPF
    <sup id="fnref2:LPF">
<a class="footnote-ref" href="#fn:LPF">
      5
     </a>
</sup>
    wird eine Grenzfrequenz (
    <code>
     cutoff
    </code>
    ) angelegt und der FC reduziert die Signale die oberhalb dieser Grenzfrequenz liegen.
   </p>
<p>
    Die Dämpfungskurve ist eine Steigung. d.h. je höher die Signalfrequenz desto stärker die Dämpfung
   </p>
<p>
<img alt="Low Pass Filter" src="../images/lowpass-filter.png" title="LowPass-Filter"/>
</p>
<p>
    Für den Einsatzbereich des Quadcopters ist der Frequenzbereich von 0-80Hz relevant, alles darüber sollte möglichst effizient weg gefiltert werden.
   </p>
<div class="admonition note">
<p class="admonition-title">
     Beachten
    </p>
<p>
     Ein fundamentaler Aspekt ist, je niedriger der die Grenzfrequenz (
     <code>
      cutoff frequency
     </code>
     ) für den Lowpass Filter ist - umso mehr muss gefiltert werden. Das wirkt sich auf dem Gesamtperformance aus. Daher gibt es mehrere andere Filter, die andere Algorithmen verwenden und das System effizienter gestalten.
    </p>
</div>
<hr/>
<h3 id="notch-filter">
<em>
     Notch-Filter
    </em>
<a class="headerlink" href="#notch-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Notch-Filter
    <sup id="fnref2:NF">
<a class="footnote-ref" href="#fn:NF">
      4
     </a>
</sup>
    eigenen sich hervorragend zur Unterdrückung von Rauschen in einem sehr spezifischen Frequenzband.
   </p>
<p>
    Notch-Filter sind in der Regel effektiver zur Reduzierung von Motorrauschen als LPF- Filter aber ggf. müssen manuelle Abstimmungen durchgeführt werden um die Bandbreite und die Mittenfrequenz zu bestimmen (Notch=Kerbe)
   </p>
<p>
    Weiterhin können Notch-Filter zur Reduzierung von Propwash genutzt werden.
   </p>
<p>
<img alt="NotchFilter" src="../images/classic_notchfilter_qfactor.png" title="Notch-Filter"/>
</p>
<p>
    Der
    <code>
     Q-Faktor
    </code>
    (Quality-Factor) gibt die Güte des Notch-Filters an und beschreibt die Weite des Filters. Je größer der Q-Faktor, desto schmaler der Notch-Filter.
   </p>
<div class="admonition note">
<p class="admonition-title">
     Beispiel
    </p>
<p>
     Du stellst fest, dass eine Vibrationsspitze bei ca 260Hz auftritt (z.B. hervorgerufen durch Propwash), dann kann der Notch-Filter
     <code>
      cutoff
     </code>
     bei ca. 200Hz beginnen und bei 300Hz enden. Der Peak soll in der Mitte des Notch-Filters liegen, somit werden auch Frequenzen etwas unter und über dieses Peaks gefiltert.
    </p>
</div>
<hr/>
<h3 id="static-filter">
<em>
     Static-Filter
    </em>
<a class="headerlink" href="#static-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Im Rahmen von Betaflight werden statische Filter als LowPass-Filter oder als Notch-Filter genutzt
   </p>
<hr/>
<h3 id="dynamic-filter">
<em>
     Dynamic-Filter
    </em>
<a class="headerlink" href="#dynamic-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Dynamic Filter reduzieren ebenfalls Rauschen, vorausgesetzt die entsprechenden Parameter richtig eingestellt sind. Schwingungen, Motorgeräusche, etc. können durch die Dynamic-Filter reduziert werden.
   </p>
<p>
    Ein Dynamic-Filter ist ein Algorithmus, der die Frequenz des Rauschens erkennen kann und er kann den Notch-Filter verwenden, um ihn automatisch zu reduzieren.
   </p>
<div class="admonition note">
<p class="admonition-title">
     Nachteil
    </p>
<p>
     von Dynamic-Filters ist die Erhöhung der CPU-Last und die Delays.
    </p>
</div>
<h2 id="betaflight-filter">
    Betaflight-Filter
    <a class="headerlink" href="#betaflight-filter" title="Permanent link">
     #
    </a>
</h2>
<h3 id="rpm-filter">
<em>
     RPM-Filter
    </em>
<a class="headerlink" href="#rpm-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    RPM-Filter
    <sup id="fnref2:RPM">
<a class="footnote-ref" href="#fn:RPM">
      1
     </a>
</sup>
    sind eine besondere Filtertechnik in Betaflight und wurden mit
    <a href="">
     BF 4.0
    </a>
    eingeführt. Die RPM-Filter können über eine Vielzahl an Parameter
    <sup id="fnref:RPMPARAM">
<a class="footnote-ref" href="#fn:RPMPARAM">
      2
     </a>
</sup>
    konfiguriert werden. Eine detaillierte Beschreibung findet man im BF-Wiki
    <a href="https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter">
     BF-RPMFilter
    </a>
    .
   </p>
<p>
    RPM-Filter basieren auf mehreren
    <a href="#bf-dynamic-notchfilter">
     Notch-Filter
    </a>
    die präzise darauf ausgerichtet sind Motorvibrationen und ihre
    <code>
     Harmonics
    </code>
    zu filtern und möglichst komplett zu elimenieren. Für jeden Motor können bis zu drei Notch-Filter (max 3 Harmonics) generiert werden (Pro Achse). Das heißt insgesamt steht eine Bank von 36 Notch-Filtern zur Verfügung. 3 Achsen * 3
    <code>
     Harmonics
    </code>
    * 4 Motoren = 36 Notch-Filter.
   </p>
<p>
    Die RPM-Filter basieren auf die Drehzahl der Motoren und dem bidrektionalen DShot-Protokoll in Zusammenspiel mit den Gyrodaten - daher auch
    <code>
     Gyro-RPM-Filter
    </code>
</p>
<div class="admonition danger">
<p class="admonition-title">
     Wichtig
    </p>
<p>
     RPM-Filter benötigen für BLHeli32 ESC die aktuellste Firmware
     <code>
      &gt;= 32.7
     </code>
     . Für BLHeli_S ESCs empfehle ich die FW von (auch wenn sie Geld kosten) JFlight
     <sup id="fnref:JFLIGHT">
<a class="footnote-ref" href="#fn:JFLIGHT">
       3
      </a>
</sup>
</p>
</div>
<div class="admonition note">
<p class="admonition-title">
     Tip
    </p>
<p>
     Durch die Einführung der RPM-Filter ist es möglich andere Filter (z.B. LPF) zu reduzieren bzw. komplett auszuschalten, dies geht zu Gunsten der Gesamtperformance des Copters und die Delays können dadurch weiter reduziert werden.
    </p>
</div>
<hr/>
<h3 id="bf-dynamic-lowpassfilter">
<em>
     BF - Dynamic-Lowpassfilter
    </em>
<a class="headerlink" href="#bf-dynamic-lowpassfilter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Neu ab [BF 4.0 - DLPF] (https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Dynamic-lowpass-filtering).
BF bietet nun die Möglichkeit, die Grenzfrequenz des LPF
    <sup id="fnref3:LPF">
<a class="footnote-ref" href="#fn:LPF">
      5
     </a>
</sup>
    bei Vollgas im Vergleich zu 0-Throttle sanft auf einen höheren Wert zu verschieben. Die dem ersten Gyro und dem D-Lowpass-Filter zugewiesene Grenzfrequenz steigt nun dynamisch mit zunehmender Drosselung entlang einer Kurve an, die effektiv die Motordrehzahl beeinflusst. Dadurch wird die Verzögerung bei Vollgas verringert, und der Dynamische-Notch Filter
    <sup id="fnref3:NF">
<a class="footnote-ref" href="#fn:NF">
      4
     </a>
</sup>
    kann die Motor-Vibrations-Peaks besser verfolgen.
   </p>
<hr/>
<h3 id="bf-static-notchfilter">
<em>
     BF - Static Notchfilter
    </em>
<a class="headerlink" href="#bf-static-notchfilter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Statische Notchfilter werden explizit mit der Center-Frequenz auf auf die Herzzahl der höchsten Vibrationen (Peak) gesetzt.
In BF kann man zwei dieser Notch-Filter aktivieren. Angegeben werden jeweils die cutoff-Frequenz und die Center-Frequenz.
   </p>
<hr/>
<h3 id="bf-dynamic-notchfilter">
<em>
     BF - Dynamic-Notchfilter
    </em>
<a class="headerlink" href="#bf-dynamic-notchfilter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Ab
    <code>
     BF 3.1
    </code>
    kann man auch
    <code>
     Dynamic Notch Filter
    </code>
<sup id="fnref4:NF">
<a class="footnote-ref" href="#fn:NF">
      4
     </a>
</sup>
    einsetzen. Dieser hocheffiziente Dynamische Notch-Filter setzt sich automatisch auf den Motor-Peak - also den aktuelle höchste Frequenz der Motor-Vibrationen, basieren auf die jeweils aktuelle FFT-Analyse. Hierdurch wirkt dieser Notch-Filter in allen Throttle-Stellungen und wandert demnach durch das Frequenzband.
   </p>
<p>
    Dynamische Notch-Filter haben eine geringere Latenzzeit als LP-Filter. Notch-Filter sind sehr effektiv und bei einer guten Abstimmung kann man sogar auf LPF-Filter verzichten. Dadurch steigert sich die Gesamtperformance des Copters.
   </p>
<p>
    LP-Filter aber einfach abschalten sollte wirklich mit bedacht gemacht werden.
   </p>
<p>
    Der Dyn-Notch-Filter ist per default eingeschaltet.
   </p>
<p>
    Es gibt zwei Notch-Filter für den GYRO. Einer oder beide können bei Bedarf abgestellt werden.
   </p>
<p>
    Default-Values sind auf 200Hz-400Hz. Diese Grenzfrequenzen arbeiten sehr gut und funktionieren bei den meisten Coptern.
   </p>
<p>
    Für eine Feinabstimmung ist es notwendig eine Blackbox- Auswertung durchzuführen (Blackbox-Explorer, PIDToolbox, Plasmatree)
   </p>
<hr/>
<h3 id="bf-static-lowpassfilter">
<em>
     BF - Static-Lowpassfilter
    </em>
<a class="headerlink" href="#bf-static-lowpassfilter" title="Permanent link">
     #
    </a>
</h3>
<p>
    In Betaflight wird zwischen zwei Static-LPF Filtern unterschieden
   </p>
<ul>
<li>
     PT1
    </li>
<li>
     BIQUAD
    </li>
</ul>
<p>
    Um einen LPF-Filter zu nutzen muss grundsätzlich die untere Grenzfrequenz (
    <code>
     cutoff
    </code>
    )) angegeben werden. Der Filter beginnt dann ab dieser Frequenz zu arbeiten. Die Cutoff-Frequenz sollte
    <strong>
     nicht
    </strong>
    unter 80Hz liegen, da hier die normalen Flugfrequenzen liegen.
   </p>
<h4 id="pt1">
    PT1
    <a class="headerlink" href="#pt1" title="Permanent link">
     #
    </a>
</h4>
<p>
    Dieser Filter hat eine etwas sanftere Kurve und ist ein LPF-Filter 1. Ordnung und hat dadurch eine geringere Latenzzeit. Der Nachteil dieses Filters, er filtert nicht so stark Vibrationen aus dem Signal (bedingt durch seine Kurvenausprägung)
   </p>
<div class="admonition note">
<p class="admonition-title">
     Tip
    </p>
<p>
     verwende für den ersten LPF-Filter die Einstellung
     <strong>
      PT1
     </strong>
     , denn er ist der schnellere Filter.
    </p>
</div>
<h4 id="biquad">
    BIQUAD
    <a class="headerlink" href="#biquad" title="Permanent link">
     #
    </a>
</h4>
<p>
    Dieser Filter hat eine deutliche steilere Kurve und filtert besser als ein PT1. Er ist ein Filter 2. Ordnung. Dadurch ist die Latenzzeit schlechter, das Filterergebniss besser.
   </p>
<hr/>
<h3 id="bf-gyro-rpm-filter">
<em>
     BF - Gyro-RPM-Filter
    </em>
<a class="headerlink" href="#bf-gyro-rpm-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Ein mächtiges neues Feature, das mit BF 4.0 eingeführt wurde und in den nachfolgenden Releasen weiter verbessert wurde.
Die RPM Filter wurden weiter oben schon beschrieben, nachfolgend eine Reihe von Detailinformationen.
   </p>
<p>
    Siehe auch die
    <a href="siehe bf_tuning_parameters Kapitel gyro-filter-gyro-rpm-notch-filter">
     dazugehörigen Parameter
    </a>
</p>
<hr/>
<h3 id="bf-gyro-lowpass-filter">
<em>
     BF - Gyro-LowPass Filter
    </em>
<a class="headerlink" href="#bf-gyro-lowpass-filter" title="Permanent link">
     #
    </a>
</h3>
<hr/>
<h3 id="bf-dterm-lowpass-filter">
<em>
     BF - DTerm LowPass Filter
    </em>
<a class="headerlink" href="#bf-dterm-lowpass-filter" title="Permanent link">
     #
    </a>
</h3>
<p>
    Der DTerm verstärkt alles - auch Vibrationssignale - somit können ungefilterte DTerm Werte die direkt zu den Motoren gesendet werden dazu führen, dass die Motoren heiß werden oder sogar überhitzen und zerstört werden.
   </p>
<p>
    Hier kommen jetzt die DTerm-Lowpass Filter -&gt; Einstellung wie bei den Static-Lowpassfilter
   </p>
<p>
    Allgemeinen ist ein Biquad-Filter das sinnvolle Minimum an Filterung mit einer Frequenz um 100 Hz bis hinunter zu 80 Hz, wenn man heiße Motoren hat.
   </p>
<div class="admonition note">
<p class="admonition-title">
     Beachten
    </p>
<p>
     Den DTERM-LPF solltet ihr grundsätzlich
     <strong>
      nicht
     </strong>
     in Eurem Setup entfernen!
    </p>
</div>
<hr/>
<h2 id="appendix">
    Appendix
    <a class="headerlink" href="#appendix" title="Permanent link">
     #
    </a>
</h2>
<h3 id="bilder-in-groerem-format">
    Bilder in größerem Format
    <a class="headerlink" href="#bilder-in-groerem-format" title="Permanent link">
     #
    </a>
</h3>
<p>
<img alt="" src="../images/oszillation_hres_0b.png"/>
<img alt="" src="../images/oszillation_hres_1.png"/>
<img alt="" src="../images/oszillation_hres_1b.png"/>
<img alt="" src="../images/oszillation_hres_2a.png"/>
</p>
<hr/>
<hr/>
<div class="footnote">
<hr/>
<ol>
<li id="fn:RPM">
<p>
<a href="https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter">
        BF-Wiki RPM-Filter
       </a>
<a class="footnote-backref" href="#fnref:RPM" title="Jump back to footnote 1 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref2:RPM" title="Jump back to footnote 1 in the text">
        ↩
       </a>
</p>
</li>
<li id="fn:RPMPARAM">
<p>
       siehe bf_tuning_parameters
       <a class="footnote-backref" href="#fnref:RPMPARAM" title="Jump back to footnote 2 in the text">
        ↩
       </a>
</p>
</li>
<li id="fn:JFLIGHT">
<p>
       [JFlight ESC FW]: (https://jflight.net/index.php)
       <a class="footnote-backref" href="#fnref:JFLIGHT" title="Jump back to footnote 3 in the text">
        ↩
       </a>
</p>
</li>
<li id="fn:NF">
<p>
       Notch-Filter = Kerb-Filter
       <a class="footnote-backref" href="#fnref:NF" title="Jump back to footnote 4 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref2:NF" title="Jump back to footnote 4 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref3:NF" title="Jump back to footnote 4 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref4:NF" title="Jump back to footnote 4 in the text">
        ↩
       </a>
</p>
</li>
<li id="fn:LPF">
<p>
       Lowpass-Filter (Tiefpassfilter)
       <a class="footnote-backref" href="#fnref:LPF" title="Jump back to footnote 5 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref2:LPF" title="Jump back to footnote 5 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref3:LPF" title="Jump back to footnote 5 in the text">
        ↩
       </a>
</p>
</li>
<li id="fn:DTF">
<p>
       Filter auf den DTerm-Wert
       <a class="footnote-backref" href="#fnref:DTF" title="Jump back to footnote 6 in the text">
        ↩
       </a>
<a class="footnote-backref" href="#fnref2:DTF" title="Jump back to footnote 6 in the text">
        ↩
       </a>
</p>
</li>
</ol>
</div>
<br/>
</div>
<footer class="container-fluid wm-page-content"><small><a class="pdf-download" download href="bf_filter.pdf" title="PDF Export">Download PDF</a></small>
<p>
    Documentation built with
    <a href="http://www.mkdocs.org/">
     MkDocs
    </a>
    using
    <a href="https://github.com/gristlabs/mkdocs-windmill">
     Windmill
    </a>
    theme by Grist Labs.
   </p>
</footer>
<script>
   mermaid.initialize();
  </script>
</body>
</html>